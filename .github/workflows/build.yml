name: Build and upload mod
on:
  release:
    types: [ published ]
    branches: [ forge-1.16.5 ]

jobs:

  build:
    name: Build with Gradle
    runs-on: ubuntu-latest
    outputs:
      file_path: ${{steps.file.outputs.file_path}}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up JDK 8
        uses: actions/setup-java@v2
        with:
          java-version: '8'
          distribution: 'adopt'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Generate data
        run: ./gradlew :runData

      - name: Build
        run: ./gradlew :build

      - name: Sets file directory
        id: file
        run: echo "::set-output name=file_name::./build/libs/towerofgod-${{github.event.release.tag_name:1}}.jar"

  release:
    name: Upload to release
    runs-on: ubuntu-latest
    needs: [ build ]
    steps:
      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{needs.build.outputs.file_path}}

  curseforge:
    name: Upload to CurseForge
    runs-on: ubuntu-latest
    needs: [ build ]
    steps:
      - name: Upload to CurseForge
        uses: itsmeow/curseforge-upload@v3
        with:
          token: ${{secrets.curseforge_api}}
          project_id: 403993
          game_endpoint: minecraft
          file_path: ${{needs.build.outputs.file_path}}
          changelog: ${{github.event.release.body}}
          display_name: ${{github.event.release.name}}
          release_type: release
          game_versions: minecraft-1-16:1.16.5,java:Java 8,Forge
